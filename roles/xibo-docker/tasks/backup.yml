---
# tasks/backup.yml

- name: Erstelle Backup-Ordner
  become: yes
  file:
    path: /opt/xibo-backup/backups
    state: directory
    owner: xibo
    group: xibo
    mode: '0755'

# ==================================================
# backup_state Tabelle + Default-Row (im DB-Container)
# ==================================================
- name: Ensure backup_state table and row exist (docker exec)
  shell: |
    docker exec -i {{ xibo_db_container }} \
      mysql -u{{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }} <<'SQL'
    CREATE TABLE IF NOT EXISTS backup_state (
      id INT PRIMARY KEY,
      db_hash CHAR(64) NOT NULL,
      media_hash CHAR(64) NOT NULL,
      updated_at TIMESTAMP
        DEFAULT CURRENT_TIMESTAMP
        ON UPDATE CURRENT_TIMESTAMP
    );

    INSERT IGNORE INTO backup_state (id, db_hash, media_hash)
    VALUES (1, '', '');
    SQL
  args:
    executable: /bin/bash
  changed_when: false

# ==================================================
# Backup-Skript deployen
# ==================================================
- name: Deploy Xibo Backup Script
  become: yes
  ansible.builtin.template:
    src: backup_xibo.sh.j2
    dest: /opt/xibo-backup/backup_xibo.sh
    owner: xibo
    group: xibo
    mode: '0755'

# ==================================================
# Log-Cleanup Skript
# ==================================================
- name: Erstelle Log-Cleanup Skript
  become: yes
  ansible.builtin.copy:
    dest: /opt/xibo-backup/cleanup_logs.sh
    owner: xibo
    group: xibo
    mode: '0755'
    content: |
      #!/bin/bash
      set -e
      LOGDIR="/opt/xibo-backup"
      find "$LOGDIR" -maxdepth 1 -type f -name "log_*.log" -mtime +30 -print -delete

# ==================================================
# Cronjob
# ==================================================
- name: Deploy cron job for automatic backup
  become: yes
  cron:
    name: "Xibo Backup (change-based)"
    user: xibo
    minute: "0"
    hour: "2"
    job: '/opt/xibo-backup/backup_xibo.sh >> /opt/xibo-backup/logs/backup_$(date +%F).log 2>&1'
