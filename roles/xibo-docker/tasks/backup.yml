---
# tasks/backup.yml

- name: Erstelle Backup-Ordner
  become: yes
  file:
    path: /opt/xibo-backup/backups
    state: directory
    owner: xibo
    group: xibo
    mode: '0755'

- name: Ensure backup_state table exists
  community.mysql.mysql_query:
    login_host: "{{ xibo_db_host }}"
    login_user: "{{ xibo_db_user }}"
    login_password: "{{ xibo_db_password }}"
    login_db: "{{ xibo_db_name }}"
    query: |
      CREATE TABLE IF NOT EXISTS backup_state (
        id INT PRIMARY KEY,
        db_hash CHAR(64) NOT NULL,
        media_hash CHAR(64) NOT NULL,
        updated_at TIMESTAMP NOT NULL
          DEFAULT CURRENT_TIMESTAMP
          ON UPDATE CURRENT_TIMESTAMP
      );

- name: Ensure backup_state row exists
  community.mysql.mysql_query:
    login_host: "{{ xibo_db_host }}"
    login_user: "{{ xibo_db_user }}"
    login_password: "{{ xibo_db_password }}"
    login_db: "{{ xibo_db_name }}"
    query: |
      INSERT IGNORE INTO backup_state (id, db_hash, media_hash)
      VALUES (1, '', '');

- name: Deploy Xibo Backup Script
  become: yes
  ansible.builtin.template:
    src: backup_xibo.sh.j2
    dest: /opt/xibo-backup/backup_xibo.sh
    owner: xibo
    group: xibo
    mode: '0755'

- name: Erstelle Log-Cleanup Skript
  become: yes
  ansible.builtin.copy:
    dest: /opt/xibo-backup/cleanup_logs.sh
    owner: xibo
    group: xibo
    mode: '0755'
    content: |
      #!/bin/bash
      set -e
      LOGDIR="/opt/xibo-backup"
      find "$LOGDIR" -maxdepth 1 -type f -name "log_*.log" -mtime +30 -print -delete

- name: Deploy cron job for automatic backup
  become: yes
  cron:
    name: "Xibo Backup (change-based)"
    user: xibo
    minute: "0"
    hour: "2"
    job: "/opt/xibo-backup/backup_xibo.sh >> /opt/xibo-backup/logs/backup_$(date +\%F).log 2>&1"
