- name: Xibo Login Check
  hosts: localhost
  gather_facts: no
  vars:
    xibo_url: "https://localhost:8080"
    xibo_username: "{{ xibo_loginname_default }}"
    xibo_password: "{{ xibo_loginpassword_default }}"

  tasks:
    - name: 1️⃣ Login-Seite abrufen (Session + CSRF-Token)
      ansible.builtin.uri:
        url: "{{ xibo_url }}/login"
        method: GET
        return_content: yes
        validate_certs: yes
      register: login_page

    - name: 2️⃣ CSRF-Token aus HTML extrahieren
      ansible.builtin.set_fact:
        csrf_token: >-
          {{ login_page.content
             | regex_search('name="csrfToken" value="([^"]+)"', '\\1') }}

    - name: Fail if CSRF token was not found
      ansible.builtin.fail:
        msg: "CSRF token konnte nicht extrahiert werden"
      when: csrf_token is not defined or csrf_token == ""

    - name: 3️⃣ Login durchführen
      ansible.builtin.uri:
        url: "{{ xibo_url }}/login"
        method: POST
        follow_redirects: all
        headers:
          Content-Type: "application/x-www-form-urlencoded"
          Cookie: "{{ login_page.cookies_string }}"
        body_format: form-urlencoded
        body:
          username: "{{ xibo_username }}"
          password: "{{ xibo_password }}"
          priorRoute: "/"
          csrfToken: "{{ csrf_token }}"
        status_code:
          - 200
          - 302
      register: login_result

    - name: 4️⃣ Prüfen, ob Login erfolgreich war
      ansible.builtin.debug:
        msg: "✅ Login erfolgreich!"
      when: login_result.status == 200 or login_result.status == 302

    - name: 4️⃣ Login fehlgeschlagen
      ansible.builtin.fail:
        msg: "❌ Login fehlgeschlagen!"
      when: login_result.status != 200 and login_result.status != 302
