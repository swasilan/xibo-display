############################################
# Admin User prüfen (DB)
############################################
- name: Check if admin user exists
  shell: >
    docker exec {{ xibo_db_container }}
    mysql -N -s
    -u{{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }}
    -e "SELECT COUNT(*) FROM user WHERE userName='{{ xibo_admin_new }}';"
  register: admin_exists
  changed_when: false

############################################
# Login nur wenn Admin noch nicht geändert
############################################
- name: Set flag if initial login is required
  set_fact:
    do_initial_login: "{{ admin_exists.stdout | int == 0 }}"

############################################
# 1️⃣ Login-Seite laden (Session + CSRF)
############################################
- name: GET login page
  ansible.builtin.uri:
    url: "{{ xibo_url }}/login"
    method: GET
    return_content: yes
    validate_certs: false
  when: do_initial_login
  register: login_page

############################################
# 2️⃣ CSRF Token extrahieren
############################################
- name: Extract CSRF token
  set_fact:
    csrf_token: "{{ login_page.content | regex_search('name=\"csrfToken\" value=\"([^\"]+)\"', '\\1') | first }}"
  when: do_initial_login

- name: Fail if CSRF token not found
  fail:
    msg: "CSRF token could not be extracted from login page"
  when: do_initial_login and (csrf_token is not defined or csrf_token == "")

############################################
# 3️⃣ Login durchführen (mit Cookie-Header)
############################################
- name: POST login
  ansible.builtin.uri:
    url: "{{ xibo_url }}/login"
    method: POST
    body_format: form-urlencoded
    headers:
      Cookie: "{{ login_page.set_cookie }}"
    body:
      username: "{{ xibo_username }}"
      password: "{{ xibo_password }}"
      csrfToken: "{{ csrf_token }}"
      priorRoute: "/"
    follow_redirects: all
    status_code: [200, 302]
    validate_certs: false
  when: do_initial_login
  register: login_result

############################################
# 4️⃣ Login-Erfolg bewerten
############################################
- name: Check if login was successful
  debug:
    msg: "✅ Login erfolgreich!"
  when: do_initial_login and (login_result.status == 200 or login_result.status == 302)

############################################
# Info
############################################
- name: Login skipped or successful
  debug:
    msg: >-
      {{ 'Initial login skipped (admin already changed)'
         if not do_initial_login
         else 'Initial login successful' }}
