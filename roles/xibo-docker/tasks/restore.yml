---
# --------------------------------------------------
# Restore-Tasks f√ºr Xibo
# --------------------------------------------------

###########################################################################
# Variablen definieren
###########################################################################
- name: Set restore paths
  set_fact:
    restore_tmp_dir: "{{ restore_tmp_dir | default('/tmp/xibo_restore') }}"
    backup_dir: "{{ backup_dir | default('/opt/xibo-backup/backups') }}"
    cms_target_dir: "{{ cms_target_dir | default('/opt/xibo-docker/shared/cms') }}"
    rollback_dir: "{{ rollback_dir | default('/opt/xibo-backup/rollback') }}"

###########################################################################
# Vorbereitungen
###########################################################################
- name: Ensure required directories exist
  file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ restore_tmp_dir }}"
    - "{{ backup_dir }}"
    - "{{ cms_target_dir }}"
    - "{{ rollback_dir }}"

###########################################################################
# Backups finden
###########################################################################
- name: Find available Xibo backups
  find:
    paths: "{{ backup_dir }}"
    patterns: "xibo_backup_*.zip"
    recurse: no
  register: found_backups

- name: Set fact if backups exist
  set_fact:
    backups_exist: "{{ found_backups.files | length > 0 }}"

- name: Warnung, dass keine Backups gefunden wurden
  debug:
    msg: "‚ö†Ô∏è Keine Backups gefunden in {{ backup_dir }}, Restore wird √ºbersprungen."
  when: not backups_exist

###########################################################################
# Backup nur wiederherstellen, wenn Backups existieren
###########################################################################
- block:
    - name: Show available backups
      ansible.builtin.debug:
        msg: |
          Verf√ºgbare Backups:
          {% for f in found_backups.files | sort(attribute='mtime', reverse=true) %}
          - {{ loop.index }}: {{ f.path | basename }} ({{ '%Y-%m-%d %H:%M:%S' | strftime(f.mtime) }})
          {% endfor %}

    - name: Ask if restore should be executed (30 Sekunden Timeout)
      shell: |
        echo ""
        echo "‚ö†Ô∏è  Es wurden {{ found_backups.files | length }} Backup(s) gefunden."
        echo "M√∂chtest du ein Backup wiederherstellen?"
        echo ""
        echo -n "Tippe 'yes' zum Fortfahren (Timeout: 30 Sekunden): "
        read -t 30 response || response=""
        echo "$response"
      register: restore_confirm_shell
      changed_when: false

    - name: Setze restore_confirm Variable
      set_fact:
        restore_confirm:
          user_input: "{{ restore_confirm_shell.stdout | default('') }}"

    - name: Skip restore notification
      debug:
        msg: "‚ÑπÔ∏è Restore √ºbersprungen (Timeout oder Ablehnung), fahre mit Installation fort."
      when: restore_confirm.user_input is not defined or restore_confirm.user_input != "yes"

    ###########################################################################
    # Restore durchf√ºhren
    ###########################################################################
    - block:
        - name: Sort backups by date
          set_fact:
            sorted_backups: "{{ found_backups.files | sort(attribute='mtime', reverse=true) }}"

        - name: Ask which backup to restore
          pause:
            prompt: |
              Bitte Nummer des Backups angeben (1‚Äì{{ found_backups.files | length }}):
          register: backup_choice

        - name: Validate backup selection
          fail:
            msg: "Ung√ºltige Auswahl."
          when: backup_choice.user_input | int < 1 or backup_choice.user_input | int > found_backups.files | length

        - name: Select chosen backup
          set_fact:
            selected_backup: "{{ sorted_backups[backup_choice.user_input | int - 1].path }}"

        - name: Confirm selected backup
          debug:
            msg: "‚úÖ Gew√§hltes Backup: {{ selected_backup }}"

        - name: Unarchive selected backup
          unarchive:
            src: "{{ selected_backup }}"
            dest: "{{ restore_tmp_dir }}"
            remote_src: yes

        - name: Restore database
          ansible.builtin.shell: |
            cat {{ restore_tmp_dir }}/db.sql | docker exec -i xibo-db mysql -uxibo -pxibopass xibo
          become: yes

        - name: Restore CMS files
          shell: |
            rsync -a --delete \
              {{ restore_tmp_dir }}/cms/ \
              {{ cms_target_dir }}/
          changed_when: true

        - name: Cleanup restore temp directory
          file:
            path: "{{ restore_tmp_dir }}"
            state: absent

        - name: Restore finished
          debug:
            msg: "üéâ Restore erfolgreich abgeschlossen."

      when: restore_confirm.user_input is defined and restore_confirm.user_input == "yes"

  when: backups_exist
