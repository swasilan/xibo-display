---
# --------------------------------------------------
# Restore-Playbook fÃ¼r Xibo
# --------------------------------------------------
- name: Xibo Restore
  hosts: local
  gather_facts: yes
  become: yes

  ###########################################################################
  # Interaktive Prompts (werden Ã¼bersprungen, wenn Vars gesetzt sind)
  ###########################################################################
  vars_prompt:

    - name: restore_confirm
      prompt: |
        âš ï¸  Es wurden Xibo-Backups gefunden.
        MÃ¶chtest du ein Backup wiederherstellen?

        Tippe 'yes' zum Fortfahren
        ENTER = Ã¼berspringen
      private: no
      default: "{{ restore_confirm | default('') }}"

    - name: backup_choice
      prompt: |
        Welches Backup soll verwendet werden?

        ðŸ‘‰ 'latest' = neuestes Backup (empfohlen)
        ðŸ‘‰ 1, 2, 3 â€¦ = Auswahl aus der Liste
      private: no
      default: "{{ backup_choice | default('latest') }}"

    - name: restore_dry_run
      prompt: |
        ðŸ›¡ Restore nur anzeigen (Dry-Run)?
        Tippe 'true' fÃ¼r Vorschau, ENTER = normaler Restore
      private: no
      default: "{{ restore_dry_run | default(false) }}"

  ###########################################################################
  # Variablen (Defaults, werden von secrets.yml Ã¼berschrieben)
  ###########################################################################
  vars:
    restore_tmp_dir: "{{ restore_tmp_dir | default('/tmp/xibo_restore') }}"
    backup_dir: "{{ backup_dir | default('/opt/xibo-backup/backups') }}"
    cms_target_dir: "{{ cms_target_dir | default('/opt/xibo-docker/shared/cms') }}"
    rollback_dir: "{{ rollback_dir | default('/opt/xibo-backup/rollback') }}"

  vars_files:
    - group_vars/secrets.yml

  tasks:
    ###########################################################################
    # Vorbereitungen
    ###########################################################################
    - name: Ensure required directories exist
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ restore_tmp_dir }}"
        - "{{ backup_dir }}"
        - "{{ cms_target_dir }}"
        - "{{ rollback_dir }}"

    ###########################################################################
    # Backups finden
    ###########################################################################
    - name: Find available Xibo backups
      find:
        paths: "{{ backup_dir }}"
        patterns: "xibo_backup_*.zip"
        recurse: no
      register: found_backups

    - name: Abort if no backups exist
      fail:
        msg: "âŒ Keine Backups gefunden in {{ backup_dir }}"
      when: found_backups.files | length == 0

    ###########################################################################
    # Backups sortieren (neu â†’ alt)
    ###########################################################################
    - name: Sort backups by date
      set_fact:
        sorted_backups: "{{ found_backups.files | sort(attribute='mtime', reverse=true) }}"

    - name: Show available backups
      debug:
        msg: |
          VerfÃ¼gbare Backups:
          {% for f in sorted_backups %}
          - {{ loop.index }}: {{ f.path | basename }}
          {% endfor %}

    ###########################################################################
    # Backup auswÃ¤hlen
    ###########################################################################
    - name: Select backup automatically or by index
      set_fact:
        selected_backup: >-
          {% if backup_choice == 'latest' %}
          {{ sorted_backups[0].path }}
          {% else %}
          {{ sorted_backups[backup_choice | int - 1].path }}
          {% endif %}

    - name: Validate backup selection
      fail:
        msg: "âŒ UngÃ¼ltige Backup-Auswahl."
      when: selected_backup is not defined

    - name: Confirm selected backup
      debug:
        msg: "âœ… GewÃ¤hltes Backup: {{ selected_backup }}"

    ###########################################################################
    # CMS-LeerprÃ¼fung (Schutz)
    ###########################################################################
    - name: Check if CMS directory is empty
      find:
        paths: "{{ cms_target_dir }}"
        file_type: any
      register: cms_files

    - name: Abort if CMS not empty and not forced
      fail:
        msg: >
          âŒ CMS-Verzeichnis ist nicht leer.
          Setze restore_force=true um trotzdem fortzufahren.
      when:
        - cms_files.matched > 0
        - not (restore_force | default(false))

    ###########################################################################
    # Dry-Run Vorschau
    ###########################################################################
    - name: Dry-run preview
      debug:
        msg: |
          ðŸ›¡ DRY-RUN
          Backup: {{ selected_backup }}
          Ziel: {{ cms_target_dir }}
          DB: db.sql â†’ xibo-db
      when: restore_dry_run | bool

    - meta: end_play
      when: restore_dry_run | bool

    ###########################################################################
    # Rollback erstellen
    ###########################################################################
    - name: Create rollback snapshot
      shell: |
        rsync -a {{ cms_target_dir }}/ {{ rollback_dir }}/cms_{{ ansible_date_time.iso8601 }}/
      changed_when: true

    ###########################################################################
    # Restore durchfÃ¼hren
    ###########################################################################
    - name: Unarchive selected backup
      unarchive:
        src: "{{ selected_backup }}"
        dest: "{{ restore_tmp_dir }}"
        remote_src: yes

    - name: Restore database
      shell: |
        cat {{ restore_tmp_dir }}/db.sql | docker exec -i xibo-db \
          mysql -uxibo -pxibopass xibo

    - name: Restore CMS files
      shell: |
        rsync -a --delete \
          {{ restore_tmp_dir }}/cms/ \
          {{ cms_target_dir }}/
      changed_when: true

    ###########################################################################
    # Cleanup
    ###########################################################################
    - name: Cleanup restore temp directory
      file:
        path: "{{ restore_tmp_dir }}"
        state: absent

    - name: Restore finished
      debug:
        msg: "ðŸŽ‰ Xibo Restore erfolgreich abgeschlossen."
t
