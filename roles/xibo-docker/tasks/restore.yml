---
# --------------------------------------------------
# Restore-Playbook f√ºr Xibo
# --------------------------------------------------

# --------------------------------------------------
# Variablen definieren
# --------------------------------------------------
- name: Set restore paths
  set_fact:
    restore_tmp_dir: /tmp/xibo_restore
    backup_dir: /opt/xibo-backup/backups
    cms_target_dir: /opt/xibo-docker/shared/cms

# --------------------------------------------------
# Verzeichnisse sicherstellen
# --------------------------------------------------
- name: Ensure restore temp directory exists
  file:
    path: "{{ restore_tmp_dir }}"
    state: directory
    mode: "0755"

- name: Ensure CMS target directory exists
  file:
    path: "{{ cms_target_dir }}"
    state: directory
    mode: "0755"

- name: Ensure backup directory exists
  file:
    path: "{{ backup_dir }}"
    state: directory
    mode: "0755"

# --------------------------------------------------
# Backups finden
# --------------------------------------------------
- name: Find available Xibo backups
  find:
    paths: "{{ backup_dir }}"
    patterns: "xibo_backup_*.zip"
    recurse: no
  register: found_backups

- name: Set fact if backups exist
  set_fact:
    backups_exist: "{{ found_backups.files | length > 0 }}"

- name: Warnung, dass keine Backups gefunden wurden
  debug:
    msg: "‚ö†Ô∏è Keine Backups gefunden in {{ backup_dir }}, Restore wird √ºbersprungen."
  when: not backups_exist

# --------------------------------------------------
# Backup nur wiederherstellen, wenn Backups existieren
# --------------------------------------------------
- block:

    - name: Show available backups
      ansible.builtin.debug:
        msg: |
          Verf√ºgbare Backups:
          {% for f in found_backups.files | sort(attribute='mtime', reverse=true) %}
          - {{ loop.index }}: {{ f.path | basename }} ({{ '%Y-%m-%d %H:%M:%S' | strftime(f.mtime) }})
          {% endfor %}

    - name: Ask if restore should be executed
      pause:
        prompt: |
          ‚ö†Ô∏è  Es wurden {{ found_backups.files | length }} Backup(s) gefunden.
          M√∂chtest du ein Backup wiederherstellen?
          Tippe 'yes' zum Fortfahren:
      register: restore_confirm

    - name: Abort restore if user declines
      fail:
        msg: "Restore vom Benutzer abgebrochen."
      when: restore_confirm.user_input != "yes"

    - name: Ask which backup to restore
      pause:
        prompt: |
          Bitte Nummer des Backups angeben (1‚Äì{{ found_backups.files | length }}):
      register: backup_choice

    - name: Validate backup selection
      fail:
        msg: "Ung√ºltige Auswahl."
      when: backup_choice.user_input | int < 1 or backup_choice.user_input | int > found_backups.files | length

    - name: Select chosen backup
      set_fact:
        selected_backup: >-
          {{ (found_backups.files | sort(attribute='mtime', reverse=true))
             [backup_choice.user_input | int - 1].path }}

    - name: Confirm selected backup
      debug:
        msg: "‚úÖ Gew√§hltes Backup: {{ selected_backup }}"

    # --------------------------------------------------
    # Backup entpacken
    # --------------------------------------------------
    - name: Unarchive selected backup
      unarchive:
        src: "{{ selected_backup }}"
        dest: "{{ restore_tmp_dir }}"
        remote_src: yes

    # --------------------------------------------------
    # Datenbank Restore
    # --------------------------------------------------
    - name: Copy DB dump into DB container
      command: >
        docker cp {{ restore_tmp_dir }}/db.sql
        {{ xibo_db_container }}:/db.sql

    - name: Restore database
      shell: |
        docker exec {{ xibo_db_container }} \
          mysql -u{{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }} < /db.sql
      changed_when: true

    # --------------------------------------------------
    # CMS Dateien Restore
    # --------------------------------------------------
    - name: Restore CMS files
      shell: |
        rsync -a --delete \
          {{ restore_tmp_dir }}/cms/ \
          {{ cms_target_dir }}/
      changed_when: true

    # --------------------------------------------------
    # Cleanup
    # --------------------------------------------------
    - name: Cleanup restore temp directory
      file:
        path: "{{ restore_tmp_dir }}"
        state: absent

    - name: Restore finished
      debug:
        msg: "üéâ Restore erfolgreich abgeschlossen."

  when: backups_exist
