---
# --------------------------------------------------
# Variablen definieren
# --------------------------------------------------
- name: Set restore paths
  set_fact:
    restore_tmp_dir: /tmp/xibo_restore
    backup_dir: /opt/xibo-backup/backups
    cms_target_dir: /opt/xibo-docker/shared/cms

- name: Ensure restore temp directory exists
  file:
    path: "{{ restore_tmp_dir }}"
    state: directory
    mode: "0755"

- name: Ensure CMS target directory exists
  file:
    path: "{{ cms_target_dir }}"
    state: directory
    mode: "0755"
    
# --------------------------------------------------
# Pr√ºfen, ob Restore-Verzeichnisse existieren
# --------------------------------------------------
- name: Check if backup directory exists
  stat:
    path: /opt/xibo-backup/backups
  register: backup_dir

- name: Find available Xibo backups
  find:
    paths: "/opt/xibo-backup/backups"
    patterns: "xibo_backup_*.zip"
    recurse: no
  register: found_backups
  when: backup_dir.stat.exists

- name: Abort if no backups found
  fail:
    msg: "‚ùå Keine Xibo Backups gefunden in /opt/xibo-backup/backups"
  when: backup_dir.stat.exists and found_backups.files | length == 0

# --------------------------------------------------
# Backup finden
# --------------------------------------------------
- stat:
    path: /opt/xibo-backup/backups
  register: backup_dir

- name: Find available Xibo backups
  find:
    paths: "/opt/xibo-backup/backups"
    patterns: "xibo_backup_*.zip"
    recurse: no
  register: found_backups
  when: backup_dir.stat.exists

- name: Show available backups
  debug:
    msg: |
      Verf√ºgbare Backups:
      {% for f in found_backups.files | sort(attribute='mtime', reverse=true) %}
      - {{ loop.index }}: {{ f.path }} ({{ f.mtime | to_datetime }})
      {% endfor %}

# --------------------------------------------------
# Benutzer fragen
# --------------------------------------------------
- name: Ask if restore should be executed
  pause:
    prompt: |
      ‚ö†Ô∏è  Es wurden {{ found_backups.files | length }} Backup(s) gefunden.
      M√∂chtest du ein Backup wiederherstellen?
      Tippe 'yes' zum Fortfahren:
  register: restore_confirm

- name: Abort restore
  fail:
    msg: "Restore vom Benutzer abgebrochen."
  when: restore_confirm.user_input != "yes"

- name: Ask which backup to restore
  pause:
    prompt: |
      Bitte Nummer des Backups angeben (1‚Äì{{ found_backups.files | length }}):
  register: backup_choice

- name: Validate backup selection
  fail:
    msg: "Ung√ºltige Auswahl."
  when: backup_choice.user_input | int < 1 or backup_choice.user_input | int > found_backups.files | length

- name: Select chosen backup
  set_fact:
    selected_backup: >-
      {{ (found_backups.files | sort(attribute='mtime', reverse=true))
         [backup_choice.user_input | int - 1].path }}

- name: Confirm selected backup
  debug:
    msg: "‚úÖ Gew√§hltes Backup: {{ selected_backup }}"

# --------------------------------------------------
# Backup entpacken
# --------------------------------------------------
- name: Unarchive selected backup
  unarchive:
    src: "{{ selected_backup }}"
    dest: "{{ restore_tmp_dir }}"
    remote_src: yes

# --------------------------------------------------
# Datenbank Restore
# --------------------------------------------------
- name: Copy DB dump into DB container
  command: >
    docker cp {{ restore_tmp_dir }}/db.sql
    {{ xibo_db_container }}:/db.sql

- name: Restore database
  shell: |
    docker exec {{ xibo_db_container }} \
      mysql -u{{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }} < /db.sql
  changed_when: true

# --------------------------------------------------
# CMS Dateien Restore
# --------------------------------------------------
- name: Restore CMS files
  shell: |
    rsync -a --delete \
      {{ restore_tmp_dir }}/cms/ \
      {{ cms_target_dir }}/
  changed_when: true

# --------------------------------------------------
# Cleanup
# --------------------------------------------------
- name: Cleanup restore temp directory
  file:
    path: "{{ restore_tmp_dir }}"
    state: absent

- name: Restore finished
  debug:
    msg: "üéâ Restore erfolgreich abgeschlossen."
