# --------------------------------------------------
# Restore vorbereiten
# --------------------------------------------------
- name: Check if restore temp directory exists
  stat:
    path: "{{ restore_tmp_dir }}"
  register: restore_tmp_dir_stat

- name: Check if CMS target directory exists
  stat:
    path: "{{ cms_target_dir }}"
  register: cms_target_dir_stat

# --------------------------------------------------
# Backup entpacken (nur, wenn restore_tmp_dir existiert)
# --------------------------------------------------
- name: Unarchive selected backup
  unarchive:
    src: "{{ selected_backup }}"
    dest: "{{ restore_tmp_dir }}"
    remote_src: yes
  when: restore_tmp_dir_stat.stat.exists

# --------------------------------------------------
# Datenbank Restore (nur, wenn restore_tmp_dir existiert)
# --------------------------------------------------
- name: Copy DB dump into DB container
  command: >
    docker cp {{ restore_tmp_dir }}/db.sql
    {{ xibo_db_container }}:/db.sql
  when: restore_tmp_dir_stat.stat.exists

- name: Restore database
  shell: |
    docker exec {{ xibo_db_container }} \
      mysql -u{{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }} < /db.sql
  changed_when: true
  when: restore_tmp_dir_stat.stat.exists

# --------------------------------------------------
# CMS Dateien Restore (nur, wenn CMS target existiert)
# --------------------------------------------------
- name: Restore CMS files
  shell: |
    rsync -a --delete \
      {{ restore_tmp_dir }}/cms/ \
      {{ cms_target_dir }}/
  changed_when: true
  when: cms_target_dir_stat.stat.exists

# --------------------------------------------------
# Cleanup (nur, wenn restore_tmp_dir existiert)
# --------------------------------------------------
- name: Cleanup restore temp directory
  file:
    path: "{{ restore_tmp_dir }}"
    state: absent
  when: restore_tmp_dir_stat.stat.exists
