# --------------------------------------------------
# Backups finden
# --------------------------------------------------
- name: Find available Xibo backups
  find:
    paths: "{{ backup_dir }}"
    patterns: "xibo_backup_*.zip"
    recurse: no
  register: found_backups

# --------------------------------------------------
# Warnung, wenn keine Backups gefunden wurden
# --------------------------------------------------
- name: Warnung, dass keine Backups gefunden wurden
  debug:
    msg: "⚠️ Keine Backups gefunden in {{ backup_dir }}, Restore wird übersprungen."
  when: found_backups.files | length == 0

# --------------------------------------------------
# Restore-Tasks nur ausführen, wenn Backups existieren
# --------------------------------------------------
- name: Show available backups
  debug:
    msg: |
      Verfügbare Backups:
      {% for f in found_backups.files | sort(attribute='mtime', reverse=true) %}
      - {{ loop.index }}: {{ f.path }} ({{ f.mtime | to_datetime }})
      {% endfor %}
  when: found_backups.files | length > 0

- name: Ask if restore should be executed
  pause:
    prompt: |
      ⚠️  Es wurden {{ found_backups.files | length }} Backup(s) gefunden.
      Möchtest du ein Backup wiederherstellen?
      Tippe 'yes' zum Fortfahren:
  register: restore_confirm
  when: found_backups.files | length > 0

- name: Abort restore
  fail:
    msg: "Restore vom Benutzer abgebrochen."
  when: found_backups.files | length > 0 and restore_confirm.user_input != "yes"

- name: Ask which backup to restore
  pause:
    prompt: |
      Bitte Nummer des Backups angeben (1–{{ found_backups.files | length }}):
  register: backup_choice
  when: found_backups.files | length > 0

- name: Validate backup selection
  fail:
    msg: "Ungültige Auswahl."
  when: found_backups.files | length > 0 and
        (backup_choice.user_input | int < 1 or backup_choice.user_input | int > found_backups.files | length)

- name: Select chosen backup
  set_fact:
    selected_backup: >-
      {{ (found_backups.files | sort(attribute='mtime', reverse=true))
         [backup_choice.user_input | int - 1].path }}
  when: found_backups.files | length > 0

- name: Unarchive selected backup
  unarchive:
    src: "{{ selected_backup }}"
    dest: "{{ restore_tmp_dir }}"
    remote_src: yes
  when: found_backups.files | length > 0
