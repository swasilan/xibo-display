---
############################################
# Validate required variables
############################################
- name: Validate required variables
  assert:
    that:
      - xibo_admin_new is defined
      - xibo_admin_old is defined
      - xibo_db_name is defined
      - xibo_db_user is defined
      - xibo_db_password is defined
    fail_msg: "Required Xibo variables are missing"

############################################
# Basis & Abhängigkeiten
############################################
- name: Install required packages
  become: yes
  apt:
    name:
      - cron
      - ca-certificates
      - msmtp
      - msmtp-mta
      - mailutils
      - python3-pymysql
      - python3-bcrypt
      - rsync
      - zip
      - docker.io
      - docker-compose
    state: present
    update_cache: yes

############################################
# Docker Compose V2 (nur wenn nötig)
############################################
- name: Check Docker Compose V2 binary
  stat:
    path: /usr/local/lib/docker/cli-plugins/docker-compose
  register: compose_bin

- name: Create Docker CLI plugin directory
  file:
    path: /usr/local/lib/docker/cli-plugins
    state: directory
    mode: '0755'
  become: yes
  when: not compose_bin.stat.exists

- name: Install Docker Compose V2
  get_url:
    url: https://github.com/docker/compose/releases/download/v2.24.5/docker-compose-linux-x86_64
    dest: /usr/local/lib/docker/cli-plugins/docker-compose
    mode: '0755'
  become: yes
  when: not compose_bin.stat.exists

############################################
# Docker Service
############################################
- name: Ensure Docker service is running
  become: yes
  service:
    name: docker
    state: started
    enabled: yes

############################################
# Verzeichnisstruktur
############################################
- name: Create Xibo directory structure
  become: yes
  file:
    path: /opt/xibo-docker
    state: directory
    owner: xibo
    group: xibo
    mode: '0755'

############################################
# Docker Compose File
############################################
- name: Deploy Docker Compose file
  become: yes
  template:
    src: docker-compose.yml.j2
    dest: /opt/xibo-docker/docker-compose.yml
    owner: xibo
    group: xibo
    mode: "0644"

############################################
# config.env – nur einmal erstellen
############################################
- name: Check if config.env exists
  stat:
    path: /opt/xibo-docker/config.env
  register: config_env

- name: Create config.env
  become: yes
  copy:
    dest: /opt/xibo-docker/config.env
    owner: xibo
    group: xibo
    mode: "0644"
    content: |
      MYSQL_ROOT_PASSWORD=rootpass
      MYSQL_DATABASE={{ xibo_db_name }}
      MYSQL_USER={{ xibo_db_user }}
      MYSQL_PASSWORD={{ xibo_db_password }}
      XMR_HOST=cms-xmr
  when: not config_env.stat.exists

############################################
# Xibo Stack starten (nur wenn nicht läuft)
############################################
- name: Check running Xibo containers
  shell: docker ps --format '{{ "{{.Names}}" }}' | grep -q xibo
  register: xibo_running
  failed_when: false
  changed_when: false

- name: Start Xibo stack
  command:
    cmd: docker compose up -d
    chdir: /opt/xibo-docker
  become: yes
  when: xibo_running.rc != 0

############################################
# Migration abwarten (nur einmal relevant)
############################################
- name: Wait for Xibo CMS migration
  shell: |
    docker logs {{ xibo_cms_container }} 2>&1 | grep -q "All Done. Took"
  register: migration_done
  retries: 60
  delay: 10
  until: migration_done.rc == 0
  changed_when: false

############################################
# DB erreichbar?
############################################
- name: Wait until DB accepts connections
  shell: |
    docker exec {{ xibo_db_container }} \
    mysqladmin ping -u{{ xibo_db_user }} -p{{ xibo_db_password }}
  register: db_ping
  retries: 30
  delay: 5
  until: db_ping.rc == 0
  changed_when: false

############################################
# Admin User prüfen
############################################
- name: Check if admin user exists
  shell: >
    docker exec {{ xibo_db_container }}
    mysql -N -s
    -u{{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }}
    -e "SELECT COUNT(*) FROM user WHERE userName='{{ xibo_admin_new }}';"
  register: admin_exists
  changed_when: false

############################################
# MySQL PROCESS Privileg nur wenn fehlt
############################################
- name: Check PROCESS privilege
  shell: >
    docker exec {{ xibo_db_container }}
    mysql -u{{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }}
    -e "SHOW GRANTS FOR '{{ xibo_db_user }}'@'%';" | grep -q PROCESS
  register: process_priv
  failed_when: false
  changed_when: false

- name: Grant PROCESS privilege
  shell: >
    docker exec xibo-db
    mysql -u root -p{{ mysql_root_password_raw.stdout }}
    -e "GRANT PROCESS ON *.* TO '{{ xibo_db_user }}'@'%'; FLUSH PRIVILEGES;"
  when:
    - mysql_root_password_raw.stdout != ""
    - process_priv.rc != 0
  changed_when: true

############################################
# Rechte auf private.key (idempotent)
############################################
- name: Set permissions on private.key
  become: yes
  file:
    path: /opt/xibo-docker/shared/cms/library/certs/private.key
    owner: www-data
    group: www-data
    mode: '0640'


# ==================================================
# Admin-User prüfen & umbenennen
# ==================================================
#- name: Check if default admin user xibo_admin exists
#  shell: >
#    docker exec {{ xibo_db_container }}
#    mysql -N -s
#    -u{{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }}
#    -e "SELECT COUNT(*) FROM user WHERE userName='xibo_admin';"
#  register: xibo_admin_exists
#  changed_when: false

#- name: Check if target user xibo already exists
#  shell: >
#    docker exec {{ xibo_db_container }}
#    mysql -N -s
#    -u{{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }}
#    -e "SELECT COUNT(*) FROM user WHERE userName='xibo';"
#  register: xibo_user_exists
#  changed_when: false

#- name: Rename xibo_admin to xibo
#  shell: >
#    docker exec {{ xibo_db_container }}
#    mysql
#    -u{{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }}
#    -e "UPDATE user SET userName='xibo' WHERE userName='xibo_admin';"
#  when:
#    - xibo_admin_exists.stdout | int == 1
#    - xibo_user_exists.stdout | int == 0
#  changed_when: true

#- name: Debug user rename skipped
#  debug:
#    msg: "ℹ️ Benutzerumbenennung übersprungen (entweder bereits umbenannt oder Zieluser existiert)."
#  when:
#    - xibo_admin_exists.stdout | int == 0
#      or xibo_user_exists.stdout | int == 1

# ==================================================
# Passwort-Hash auslesen
# ==================================================
#- name: Read current password hash
#  shell: |
#    docker exec {{ xibo_db_container }} \
#      mysql -N -s \
#      -u{{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }} \
#      -e "SELECT userPassword FROM user WHERE userName='{{ xibo_admin_new }}';"
#  register: current_hash
#  changed_when: false

# ==================================================
# Hash-Typ erkennen (MD5 vs bcrypt)
# ==================================================
#- name: Check if password equals default "password"
#  copy:
#    dest: /tmp/check_xibo_password.py
#    mode: "0700"
#    content: |
#      import bcrypt, hashlib, sys
#
#      h = "{{ current_hash.stdout }}".strip()

#      # MD5 check
#      if len(h) == 32:
#          if h == hashlib.md5(b"password").hexdigest():
#              print("true")
#              sys.exit(0)

#      # bcrypt check
#      if h.startswith("$2"):
#          try:
#              if bcrypt.checkpw(b"password", h.encode()):
#                  print("true")
#                  sys.exit(0)
#          except ValueError:
#              pass

#      print("false")

#- name: Run password check
#  command: python3 /tmp/check_xibo_password.py
#  register: password_is_default
#  changed_when: false

#- name: Remove password check script
#  file:
#    path: /tmp/check_xibo_password.py
#    state: absent

# ==================================================
# bcrypt erzeugen (nur wenn nötig)
# ==================================================
#- name: Generate bcrypt hash for new password
#  shell: |
#    python3 <<'EOF'
#    import bcrypt
#    print(bcrypt.hashpw(b"xibo", bcrypt.gensalt()).decode())
#    EOF
#  register: xibo_bcrypt
#  changed_when: false

# ==================================================
# Passwort aktualisieren (MD5 → bcrypt)
# ==================================================
#- name: Set admin password to bcrypt(xibo)
#  shell: |
#    docker exec -i {{ xibo_db_container }} mysql \
#      -u{{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }} <<'SQL'
#    UPDATE user
#    SET userPassword='{{ xibo_bcrypt.stdout }}'
#    WHERE userName='xibo';
#    SQL
#  when: password_is_default
#  changed_when: true

# ==================================================
# Xibo Prozess Privilegien auf mysql geben
# ==================================================
#- name: Get generated MySQL root password from logs
#  shell: >
#    docker logs xibo-db 2>&1 |
#    grep "GENERATED ROOT PASSWORD" |
#    awk '{print $NF}'
#  register: mysql_root_password_raw
#  changed_when: false

#- name: Grant PROCESS privilege to xibo database user
#  shell: >
#    docker exec xibo-db
#    mysql -u root -p{{ mysql_root_password_raw.stdout }}
#    -e "GRANT PROCESS ON *.* TO 'xibo'@'%'; FLUSH PRIVILEGES;"
#  when: mysql_root_password_raw.stdout != ""
#  changed_when: true
