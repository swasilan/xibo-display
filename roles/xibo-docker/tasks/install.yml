---
# ==================================================
# Basis & Abhängigkeiten
# ==================================================
- name: Install required packages
  become: yes
  apt:
    name:
      - cron
      - ca-certificates
      - msmtp
      - msmtp-mta
      - mailutils
      - python3-pymysql
      - python3-bcrypt
      - rsync
      - zip
      - docker.io
      - docker-compose
    state: present
    update_cache: yes

- name: Ensure Docker service is running
  become: yes
  service:
    name: docker
    state: started
    enabled: yes

# ==================================================
# Verzeichnisstruktur
# ==================================================
- name: Create Xibo directory structure
  become: yes
  file:
    path: "/opt/xibo-docker/{{ item }}"
    state: directory
    owner: xibo
    group: xibo
    mode: "0755"
  loop:
    - shared
    - shared/db
    - shared/backup
    - shared/cms
    - shared/cms/library
    - shared/cms/custom
    - shared/cms/web/theme/custom
    - shared/cms/web/userscripts
    - shared/cms/ca-certs

# ==================================================
# config.env (required by compose)
# ==================================================
- name: Ensure config.env exists
  become: yes
  copy:
    dest: /opt/xibo-docker/config.env
    owner: xibo
    group: xibo
    mode: "0644"
    content: |
      MYSQL_ROOT_PASSWORD={{ xibo_db_root_password | default('rootpass') }}
      MYSQL_DATABASE={{ xibo_db_name }}
      MYSQL_USER={{ xibo_db_user }}
      MYSQL_PASSWORD={{ xibo_db_password }}
      XMR_HOST=cms-xmr

# ==================================================
# Docker Compose
# ==================================================
- name: Deploy docker-compose.yml
  become: yes
  template:
    src: docker-compose.yml.j2
    dest: /opt/xibo-docker/docker-compose.yml
    owner: xibo
    group: xibo
    mode: "0644"

# ==================================================
# Xibo Stack starten (idempotent)
# ==================================================
- name: Start Xibo stack
  community.docker.docker_compose:
    project_src: /opt/xibo-docker
    state: present

# ==================================================
# Warten bis MySQL erreichbar ist (robust!)
# ==================================================
- name: Wait until MySQL responds
  command: >
    docker exec {{ xibo_db_container }}
    mysqladmin ping
    -u{{ xibo_db_user }} -p{{ xibo_db_password }}
  register: mysql_ping
  until: mysql_ping.rc == 0
  retries: 30
  delay: 5
  changed_when: false

# ==================================================
# Admin-User umbenennen (einmalig)
# ==================================================
- name: Check if new admin user already exists
  command: >
    docker exec {{ xibo_db_container }}
    mysql -u{{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }} -sNe
    "SELECT 1 FROM user WHERE userName='{{ xibo_admin_new }}';"
  register: admin_exists
  changed_when: false

- name: Rename Xibo admin user
  command: >
    docker exec {{ xibo_db_container }}
    mysql -u{{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }} -e
    "UPDATE user
     SET userName='{{ xibo_admin_new }}'
     WHERE userName='{{ xibo_admin_old }}';"
  when: admin_exists.stdout == ""
  changed_when: true

# ==================================================
# Admin-Passwort nur ändern, wenn Default ("password")
# ==================================================
- name: Read current admin password hash
  shell: |
    docker exec {{ xibo_db_container }} \
    mysql -N -u{{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }} \
    -e "SELECT userPassword FROM user WHERE userName='{{ xibo_admin_new }}';"
  register: current_hash
  changed_when: false

- name: Check if password is default
  copy:
    dest: /tmp/check_xibo_password.py
    mode: "0700"
    content: |
      import bcrypt
      h = b'{{ current_hash.stdout }}'
      print("true" if bcrypt.checkpw(b"password", h) else "false")

- name: Run password check
  command: python3 /tmp/check_xibo_password.py
  register: password_is_default
  changed_when: false

- name: Remove password check script
  file:
    path: /tmp/check_xibo_password.py
    state: absent

- name: Generate bcrypt hash for new password
  shell: |
    python3 <<'EOF'
    import bcrypt
    print(bcrypt.hashpw(b"{{ xibo_admin_new }}", bcrypt.gensalt()).decode())
    EOF
  register: new_hash
  changed_when: false
  when: password_is_default.stdout == "true"

- name: Update admin password
  shell: |
    docker exec -i {{ xibo_db_container }} mysql \
      -u{{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }} <<'SQL'
    UPDATE user
    SET userPassword='{{ new_hash.stdout }}'
    WHERE userName='{{ xibo_admin_new }}';
    SQL
  when: password_is_default.stdout == "true"
  changed_when: true

# ==================================================
# Backup-State-Tabelle (für Change-Backups)
# ==================================================
- name: Ensure backup_state table exists
  community.docker.docker_container_exec:
    container: "{{ xibo_db_container }}"
    command: >
      mysql -u{{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }} -e "
      CREATE TABLE IF NOT EXISTS backup_state (
        id INT PRIMARY KEY,
        db_hash CHAR(64),
        media_hash CHAR(64)
      );
      INSERT IGNORE INTO backup_state (id, db_hash, media_hash)
      VALUES (1, '', '');
      "
