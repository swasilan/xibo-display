---
- name: Validate required variables
  assert:
    that:
      - xibo_admin_new is defined
      - xibo_admin_old is defined
      - xibo_db_name is defined
      - xibo_db_user is defined
      - xibo_db_password is defined
    fail_msg: "Required Xibo variables are missing"
    
# ==================================================
# Basis & Abhängigkeiten
# ==================================================
- name: Install required packages
  become: yes
  apt:
    name:
      - cron
      - ca-certificates
      - msmtp
      - msmtp-mta
      - mailutils
      - python3-pymysql
      - python3-bcrypt
      - rsync
      - zip
      - docker.io
      - docker-compose
    state: present
    update_cache: yes

- name: Ensure Docker service is running
  become: yes
  service:
    name: docker
    state: started
    enabled: yes

# ==================================================
# Verzeichnisstruktur
# ==================================================
- name: Create Xibo directory structure
  become: yes
  file:
    path: "/opt/xibo-docker/{{ item }}"
    state: directory
    owner: xibo
    group: xibo
    mode: "0755"
  loop:
    - shared
    - shared/db
    - shared/backup
    - shared/cms
    - shared/cms/library
    - shared/cms/custom
    - shared/cms/web/theme/custom
    - shared/cms/web/userscripts
    - shared/cms/ca-certs

# ==================================================
# config.env
# ==================================================
- name: Ensure config.env exists
  become: yes
  copy:
    dest: /opt/xibo-docker/config.env
    owner: xibo
    group: xibo
    mode: "0644"
    content: |
      MYSQL_ROOT_PASSWORD=rootpass
      MYSQL_DATABASE={{ xibo_db_name }}
      MYSQL_USER={{ xibo_db_user }}
      MYSQL_PASSWORD={{ xibo_db_password }}
      XMR_HOST=cms-xmr

# ==================================================
# Docker Compose
# ==================================================
- name: Deploy Docker Compose file
  become: yes
  template:
    src: docker-compose.yml.j2
    dest: /opt/xibo-docker/docker-compose.yml
    owner: xibo
    group: xibo
    mode: "0644"

# ==================================================
# Xibo Stack starten
# ==================================================
- name: Start Xibo stack
  community.docker.docker_compose:
    project_src: /opt/xibo-docker
    state: present

# ==================================================
# Warten bis DB erreichbar (robust)
# ==================================================
- name: Wait until DB accepts connections
  shell: |
    docker exec {{ xibo_db_container }} \
    mysqladmin ping -u{{ xibo_db_user }} -p{{ xibo_db_password }}
  register: db_ping
  retries: 30
  delay: 5
  until: db_ping.rc == 0
  changed_when: false

# ==================================================
# Admin-User prüfen & umbenennen
# ==================================================
- name: Check if default admin user xibo_admin exists
  shell: >
    docker exec {{ xibo_db_container }}
    mysql -N -s
    -u{{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }}
    -e "SELECT COUNT(*) FROM user WHERE userName='xibo_admin';"
  register: xibo_admin_exists
  changed_when: false

- name: Check if target user xibo already exists
  shell: >
    docker exec {{ xibo_db_container }}
    mysql -N -s
    -u{{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }}
    -e "SELECT COUNT(*) FROM user WHERE userName='xibo';"
  register: xibo_user_exists
  changed_when: false

- name: Rename xibo_admin to xibo
  shell: >
    docker exec {{ xibo_db_container }}
    mysql
    -u{{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }}
    -e "UPDATE user SET userName='xibo' WHERE userName='xibo_admin';"
  when:
    - xibo_admin_exists.stdout | int == 1
    - xibo_user_exists.stdout | int == 0
  changed_when: true

- name: Debug user rename skipped
  debug:
    msg: "ℹ️ Benutzerumbenennung übersprungen (entweder bereits umbenannt oder Zieluser existiert)."
  when:
    - xibo_admin_exists.stdout | int == 0
      or xibo_user_exists.stdout | int == 1

# ==================================================
# Passwort-Hash auslesen
# ==================================================
- name: Read current password hash
  shell: |
    docker exec {{ xibo_db_container }} \
      mysql -N -s \
      -u{{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }} \
      -e "SELECT userPassword FROM user WHERE userName='{{ xibo_admin_new }}';"
  register: current_hash
  changed_when: false

# ==================================================
# Hash-Typ erkennen (MD5 vs bcrypt)
# ==================================================
- name: Check if password equals default "password"
  copy:
    dest: /tmp/check_xibo_password.py
    mode: "0700"
    content: |
      import bcrypt, hashlib, sys

      h = "{{ current_hash.stdout }}".strip()

      # MD5 check
      if len(h) == 32:
          if h == hashlib.md5(b"password").hexdigest():
              print("true")
              sys.exit(0)

      # bcrypt check
      if h.startswith("$2"):
          try:
              if bcrypt.checkpw(b"password", h.encode()):
                  print("true")
                  sys.exit(0)
          except ValueError:
              pass

      print("false")

- name: Run password check
  command: python3 /tmp/check_xibo_password.py
  register: password_is_default
  changed_when: false

- name: Remove password check script
  file:
    path: /tmp/check_xibo_password.py
    state: absent

# ==================================================
# bcrypt erzeugen (nur wenn nötig)
# ==================================================
- name: Generate bcrypt hash for new password
  shell: |
    python3 <<'EOF'
    import bcrypt
    print(bcrypt.hashpw(b"xibo", bcrypt.gensalt()).decode())
    EOF
  register: xibo_bcrypt
  changed_when: false

# ==================================================
# Passwort aktualisieren (MD5 → bcrypt)
# ==================================================
- name: Set admin password to bcrypt(xibo)
  shell: |
    docker exec -i {{ xibo_db_container }} mysql \
      -u{{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }} <<'SQL'
    UPDATE user
    SET userPassword='{{ xibo_bcrypt.stdout }}'
    WHERE userName='xibo';
    SQL
  when: password_is_default
  changed_when: true

# ==================================================
# backup_state Tabelle
# ==================================================
- name: Ensure backup_state table exists
  shell: |
    docker exec {{ xibo_db_container }} mysql \
      -u{{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }} <<'SQL'
    CREATE TABLE IF NOT EXISTS backup_state (
      id INT PRIMARY KEY,
      db_hash CHAR(64) NOT NULL,
      media_hash CHAR(64) NOT NULL,
      updated_at TIMESTAMP
        DEFAULT CURRENT_TIMESTAMP
        ON UPDATE CURRENT_TIMESTAMP
    );
    INSERT IGNORE INTO backup_state (id, db_hash, media_hash)
    VALUES (1, '', '');
    SQL
  changed_when: false

