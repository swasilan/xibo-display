---
# --------------------------------------------------
# Basis & Abhängigkeiten
# --------------------------------------------------
- name: Installiere benötigte Pakete
  become: yes
  apt:
    name:
      - cron
      - ca-certificates
      - msmtp
      - msmtp-mta
      - mailutils
      - python3-pymysql
      - python3-bcrypt
      - rsync
      - zip
      - docker.io
      - docker-compose
    state: present
    update_cache: yes

- name: Ensure Docker service is running
  become: yes
  service:
    name: docker
    state: started
    enabled: yes

# --------------------------------------------------
# Verzeichnisstruktur
# --------------------------------------------------
- name: Create Xibo directory structure
  become: yes
  file:
    path: "/opt/xibo-docker/{{ item }}"
    state: directory
    owner: xibo
    group: xibo
    mode: "0755"
  loop:
    - shared
    - shared/db
    - shared/backup
    - shared/cms
    - shared/cms/library
    - shared/cms/custom
    - shared/cms/web/theme/custom
    - shared/cms/web/userscripts
    - shared/cms/ca-certs

- name: Ensure config.env exists
  ansible.builtin.copy:
    dest: /opt/xibo-docker/config.env
    owner: xibo
    group: xibo
    mode: '0644'
    content: |
      MYSQL_ROOT_PASSWORD=rootpass
      MYSQL_DATABASE={{ xibo_db_name }}
      MYSQL_USER={{ xibo_db_user }}
      MYSQL_PASSWORD={{ xibo_db_password }}
      XMR_HOST=cms-xmr

# --------------------------------------------------
# Docker Compose
# --------------------------------------------------
- name: Deploy Docker Compose file for Xibo
  become: yes
  template:
    src: docker-compose.yml.j2
    dest: /opt/xibo-docker/docker-compose.yml
    owner: xibo
    group: xibo
    mode: "0644"
  notify: Restart Xibo stack

# --------------------------------------------------
# Xibo Stack starten
# --------------------------------------------------
- name: Start Xibo stack (idempotent)
  community.docker.docker_compose:
    project_src: /opt/xibo-docker
    state: present

# --------------------------------------------------
# Warten bis DB healthy
# --------------------------------------------------
- name: Wait until Xibo DB container is healthy
  community.docker.docker_container_info:
    name: "{{ xibo_db_container }}"
  register: db_info
  until: db_info.container.State.Health.Status == "healthy"
  retries: 30
  delay: 10

# --------------------------------------------------
# Admin-User prüfen
# --------------------------------------------------
- name: Check if admin user already renamed
  command: >
    docker exec {{ xibo_db_container }}
    mysql -u {{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }} -sNe
    "SELECT 1 FROM user WHERE userName='{{ xibo_admin_new }}';"
  register: xibo_user_check
  changed_when: false

- name: Rename Xibo admin user
  command: >
    docker exec {{ xibo_db_container }}
    mysql -u {{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }} -e
    "UPDATE user SET userName='{{ xibo_admin_new }}'
     WHERE userName='{{ xibo_admin_old }}';"
  when: xibo_user_check.stdout == ""
  changed_when: true

# --------------------------------------------------
# Admin-Passwort nur ändern, wenn Default
# --------------------------------------------------
- name: Get current password hash
  shell: |
    docker exec {{ xibo_db_container }} \
    mysql -N -u{{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }} \
    -e "SELECT userPassword FROM user WHERE userName='{{ xibo_admin_new }}';"
  register: current_hash
  changed_when: false

- name: Check if password is default
  copy:
    dest: /tmp/check_xibo_password.py
    mode: "0700"
    content: |
      import bcrypt
      db_hash = b'{{ current_hash.stdout }}'
      default = b'password'
      print("true" if bcrypt.checkpw(default, db_hash) else "false")

- name: Run password check
  command: python3 /tmp/check_xibo_password.py
  register: password_is_default
  changed_when: false

- name: Remove password check script
  file:
    path: /tmp/check_xibo_password.py
    state: absent

- name: Generate bcrypt hash for new password
  shell: |
    python3 <<'EOF'
    import bcrypt
    print(bcrypt.hashpw(b"{{ xibo_admin_new }}", bcrypt.gensalt()).decode())
    EOF
  register: new_hash
  changed_when: false
  when: password_is_default.stdout == "true"

- name: Update admin password
  shell: |
    docker exec -i {{ xibo_db_container }} mysql \
      -u{{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }} <<'SQL'
    UPDATE user
    SET userPassword='{{ new_hash.stdout }}'
    WHERE userName='{{ xibo_admin_new }}';
    SQL
  when: password_is_default.stdout == "true"
  changed_when: true

- name: Ensure backup_state table exists
  community.docker.docker_container_exec:
    container: "{{ xibo_db_container }}"
    command: >
      mysql -u{{ xibo_db_user }} -p{{ xibo_db_password }} {{ xibo_db_name }} -e "
      CREATE TABLE IF NOT EXISTS backup_state (
        id INT PRIMARY KEY,
        db_hash CHAR(64),
        media_hash CHAR(64)
      );
      INSERT IGNORE INTO backup_state (id, db_hash, media_hash)
      VALUES (1, '', '');
      "

