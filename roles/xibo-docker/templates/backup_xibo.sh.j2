#!/usr/bin/env bash
set -euo pipefail

# -------------------------------------------------------------------
# Konfiguration (durch Ansible)
# -------------------------------------------------------------------
BACKUP_BASE="{{ backup_base | default('/opt/xibo-backup') }}"
BACKUP_DIR="$BACKUP_BASE/backups"
LOG_DIR="$BACKUP_BASE/logs"

DB_CONTAINER="{{ xibo_db_container }}"
DB_NAME="{{ xibo_db_name }}"
DB_USER="{{ xibo_db_user }}"
DB_PASS="{{ xibo_db_password }}"

CMS_PATH="{{ xibo_cms_path }}"
MEDIA_PATH="$CMS_PATH/library"

MIN_BACKUPS={{ backup_min_backups | default(5) }}
MAX_BACKUPS={{ backup_max_backups | default(30) }}

ALERT_EMAIL="{{ backup_alert_email | default('') }}"

# -------------------------------------------------------------------
# Setup
# -------------------------------------------------------------------
mkdir -p "$BACKUP_DIR" "$LOG_DIR"

TMP_DIR="$(mktemp -d)"
TIMESTAMP="$(date +'%Y%m%d_%H%M%S')"
LOG_DATE="$(date +'%F')"
LOG_FILE="$LOG_DIR/backup_$LOG_DATE.log"

exec >>"$LOG_FILE" 2>&1

log() {
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*"
}

cleanup() {
  rm -rf "$TMP_DIR"
}
trap cleanup EXIT

log "===== Xibo Backup gestartet ====="
log "Temp-Verzeichnis: $TMP_DIR"

# -------------------------------------------------------------------
# DB-Änderungen erkennen (information_schema Fingerprint)
# -------------------------------------------------------------------
log "Berechne DB-Fingerprint"

DB_HASH="$(
docker exec "$DB_CONTAINER" mysql -N -B \
  -u"$DB_USER" -p"$DB_PASS" "$DB_NAME" <<'SQL'
SELECT
  table_name,
  table_rows,
  data_length,
  index_length,
  auto_increment
FROM information_schema.tables
WHERE table_schema = DATABASE()
ORDER BY table_name;
SQL
)" | sha256sum | awk '{print $1}'

log "DB-Hash: $DB_HASH"

# -------------------------------------------------------------------
# Media-Fingerprint (Uploads)
# -------------------------------------------------------------------
log "Berechne Media-Fingerprint"

MEDIA_HASH="$(
  find "$MEDIA_PATH" -type f -printf '%P|%s|%T@\n' \
  | sort \
  | sha256sum \
  | awk '{print $1}'
)"

log "Media-Hash: $MEDIA_HASH"

# -------------------------------------------------------------------
# Alten Zustand laden
# -------------------------------------------------------------------
read OLD_DB_HASH OLD_MEDIA_HASH < <(
docker exec "$DB_CONTAINER" mysql -N -B \
  -u"$DB_USER" -p"$DB_PASS" "$DB_NAME" \
  -e "SELECT db_hash, media_hash FROM backup_state WHERE id=1;"
)

log "Alter DB-Hash: ${OLD_DB_HASH:-<none>}"
log "Alter Media-Hash: ${OLD_MEDIA_HASH:-<none>}"

DO_BACKUP=false

[[ "$DB_HASH" != "$OLD_DB_HASH" ]] && DO_BACKUP=true
[[ "$MEDIA_HASH" != "$OLD_MEDIA_HASH" ]] && DO_BACKUP=true

# -------------------------------------------------------------------
# Backup
# -------------------------------------------------------------------
if [[ "$DO_BACKUP" == true ]]; then
  BACKUP_FILE="$BACKUP_DIR/xibo_backup_$TIMESTAMP.zip"

  log "Änderung erkannt → erstelle Backup $BACKUP_FILE"

  log "DB-Dump"
  docker exec "$DB_CONTAINER" mysqldump \
    --single-transaction --quick --skip-comments --skip-dump-date \
    -u"$DB_USER" -p"$DB_PASS" "$DB_NAME" \
    > "$TMP_DIR/db.sql"

  log "CMS-Dateien"
  rsync -a "$CMS_PATH/" "$TMP_DIR/cms/"

  (cd "$TMP_DIR" && zip -rq "$BACKUP_FILE" .)

  log "Backup erfolgreich: $BACKUP_FILE"
  ls -lh "$BACKUP_FILE"

  docker exec "$DB_CONTAINER" mysql \
    -u"$DB_USER" -p"$DB_PASS" "$DB_NAME" \
    -e "
      UPDATE backup_state
      SET
        db_hash='$DB_HASH',
        media_hash='$MEDIA_HASH'
      WHERE id=1;
    "

else
  log "Keine Änderung erkannt → kein Backup"
fi

# -------------------------------------------------------------------
# Retention
# -------------------------------------------------------------------
mapfile -t BACKUPS < <(ls -1t "$BACKUP_DIR"/xibo_backup_*.zip 2>/dev/null || true)
COUNT="${#BACKUPS[@]}"

log "Backups vorhanden: $COUNT"

if (( COUNT > MAX_BACKUPS )); then
  for ((i=MAX_BACKUPS; i<COUNT; i++)); do
    log "Lösche altes Backup: ${BACKUPS[$i]}"
    rm -f "${BACKUPS[$i]}"
  done
fi

log "===== Xibo Backup beendet ====="
