#!/bin/bash
################################################################################
# Xibo Backup Restore Script
################################################################################
# Automatisch generiert durch Ansible
# Dieses Skript ermöglicht die interaktive Wiederherstellung von Xibo-Backups
################################################################################

set -euo pipefail

# Farben für bessere Lesbarkeit
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Konfiguration (aus Ansible-Variablen)
BACKUP_DIR="{{ backup_dir }}"
RESTORE_TMP_DIR="{{ restore_tmp_dir }}"
CMS_TARGET_DIR="{{ cms_target_dir }}"
ROLLBACK_DIR="{{ rollback_dir }}"
DB_CONTAINER="{{ xibo_db_container }}"
DB_NAME="{{ xibo_db_name }}"
DB_USER="{{ xibo_db_user }}"
DB_PASSWORD="{{ xibo_db_password }}"

# Logging
log_info() {
    echo -e "${BLUE}ℹ️  $1${NC}"
}

log_success() {
    echo -e "${GREEN}✅ $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}⚠️  $1${NC}"
}

log_error() {
    echo -e "${RED}❌ $1${NC}"
}

# Header anzeigen
show_header() {
    echo ""
    echo "════════════════════════════════════════════════════════════════════════════"
    echo "                    Xibo Backup Restore Tool                                "
    echo "════════════════════════════════════════════════════════════════════════════"
    echo ""
}

# Prüfe ob Script als root läuft
check_root() {
    if [[ $EUID -ne 0 ]]; then
        log_error "Dieses Script muss als root ausgeführt werden!"
        echo "Bitte verwende: sudo $0"
        exit 1
    fi
}

# Prüfe ob Docker läuft
check_docker() {
    if ! docker ps &>/dev/null; then
        log_error "Docker läuft nicht oder ist nicht verfügbar!"
        exit 1
    fi
}

# Prüfe ob Xibo Container laufen
check_xibo_containers() {
    if ! docker ps --format '{% raw %}{{.Names}}{% endraw %}' | grep -q "^${DB_CONTAINER}$"; then
        log_error "Xibo Datenbank Container '${DB_CONTAINER}' läuft nicht!"
        log_info "Bitte starte die Xibo Container zuerst."
        exit 1
    fi
}

# Finde verfügbare Backups
find_backups() {
    log_info "Suche nach Backups in ${BACKUP_DIR}..."
    
    mapfile -t BACKUP_FILES < <(find "${BACKUP_DIR}" -maxdepth 1 -name "xibo_backup_*.zip" -type f | sort -r)
    
    if [[ ${#BACKUP_FILES[@]} -eq 0 ]]; then
        log_error "Keine Backups gefunden in ${BACKUP_DIR}"
        exit 1
    fi
    
    log_success "${#BACKUP_FILES[@]} Backup(s) gefunden"
}

# Zeige verfügbare Backups
show_backups() {
    echo ""
    echo "Verfügbare Backups:"
    echo "─────────────────────────────────────────────────────────────────────────"
    
    local index=1
    for backup in "${BACKUP_FILES[@]}"; do
        local filename=$(basename "$backup")
        local size=$(du -h "$backup" | cut -f1)
        local date=$(stat -c %y "$backup" | cut -d' ' -f1,2 | cut -d'.' -f1)
        
        printf "%2d) %-40s  %8s  %s\n" "$index" "$filename" "$size" "$date"
        ((index++))
    done
    
    echo "─────────────────────────────────────────────────────────────────────────"
    echo " 0) Abbrechen"
    echo "─────────────────────────────────────────────────────────────────────────"
    echo ""
}

# Backup-Auswahl
select_backup() {
    local choice
    while true; do
        read -p "Welches Backup möchtest du wiederherstellen? [0-${#BACKUP_FILES[@]}]: " choice
        
        # Abbrechen
        if [[ "$choice" == "0" ]]; then
            log_info "Restore abgebrochen."
            exit 0
        fi
        
        # Validierung
        if [[ "$choice" =~ ^[0-9]+$ ]] && [[ "$choice" -ge 1 ]] && [[ "$choice" -le ${#BACKUP_FILES[@]} ]]; then
            SELECTED_BACKUP="${BACKUP_FILES[$((choice-1))]}"
            log_success "Gewählt: $(basename "$SELECTED_BACKUP")"
            return 0
        else
            log_error "Ungültige Eingabe. Bitte wähle eine Nummer zwischen 0 und ${#BACKUP_FILES[@]}."
        fi
    done
}

# Bestätigung einholen
confirm_restore() {
    echo ""
    log_warning "ACHTUNG: Dieser Vorgang wird die aktuelle Xibo-Installation überschreiben!"
    echo ""
    echo "Folgendes wird wiederhergestellt:"
    echo "  • Datenbank: ${DB_CONTAINER}/${DB_NAME}"
    echo "  • CMS Dateien: ${CMS_TARGET_DIR}"
    echo "  • Quelle: $(basename "$SELECTED_BACKUP")"
    echo ""
    
    read -p "Möchtest du fortfahren? (yes/no): " confirm
    
    if [[ "$confirm" != "yes" ]]; then
        log_info "Restore abgebrochen."
        exit 0
    fi
}

# Erstelle Rollback (vor Restore)
create_rollback() {
    log_info "Erstelle Rollback-Sicherung der aktuellen Installation..."
    
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local rollback_file="${ROLLBACK_DIR}/pre_restore_${timestamp}.zip"
    
    # Temporäres Verzeichnis für Rollback
    local rollback_tmp="/tmp/xibo_rollback_$$"
    mkdir -p "${rollback_tmp}"
    
    # Datenbank exportieren
    log_info "Exportiere aktuelle Datenbank..."
    docker exec "${DB_CONTAINER}" mysqldump \
        -u"${DB_USER}" \
        -p"${DB_PASSWORD}" \
        "${DB_NAME}" > "${rollback_tmp}/db.sql"
    
    # CMS Dateien kopieren
    log_info "Kopiere aktuelle CMS-Dateien..."
    mkdir -p "${rollback_tmp}/cms"
    rsync -a "${CMS_TARGET_DIR}/" "${rollback_tmp}/cms/"
    
    # Rollback-Archiv erstellen
    log_info "Erstelle Rollback-Archiv..."
    (cd "${rollback_tmp}" && zip -r "${rollback_file}" .)
    
    # Aufräumen
    rm -rf "${rollback_tmp}"
    
    log_success "Rollback erstellt: ${rollback_file}"
}

# Restore durchführen
perform_restore() {
    log_info "Starte Restore-Vorgang..."
    
    # Temporäres Verzeichnis vorbereiten
    log_info "Bereite temporäres Verzeichnis vor..."
    rm -rf "${RESTORE_TMP_DIR}"
    mkdir -p "${RESTORE_TMP_DIR}"
    
    # Backup entpacken
    log_info "Entpacke Backup..."
    unzip -q "${SELECTED_BACKUP}" -d "${RESTORE_TMP_DIR}"
    
    # Datenbank wiederherstellen
    log_info "Stelle Datenbank wieder her..."
    if [[ ! -f "${RESTORE_TMP_DIR}/db.sql" ]]; then
        log_error "Keine db.sql im Backup gefunden!"
        exit 1
    fi
    
    cat "${RESTORE_TMP_DIR}/db.sql" | docker exec -i "${DB_CONTAINER}" \
        mysql -u"${DB_USER}" -p"${DB_PASSWORD}" "${DB_NAME}"
    
    log_success "Datenbank wiederhergestellt"
    
    # CMS Dateien wiederherstellen
    log_info "Stelle CMS-Dateien wieder her..."
    if [[ ! -d "${RESTORE_TMP_DIR}/cms" ]]; then
        log_error "Kein cms/ Verzeichnis im Backup gefunden!"
        exit 1
    fi
    
    rsync -a --delete "${RESTORE_TMP_DIR}/cms/" "${CMS_TARGET_DIR}/"
    
    log_success "CMS-Dateien wiederhergestellt"
    
    # Aufräumen
    log_info "Räume auf..."
    rm -rf "${RESTORE_TMP_DIR}"
    
    log_success "Temporäre Dateien entfernt"
}

# Container neustarten
restart_containers() {
    log_info "Starte Xibo-Container neu..."
    
    cd "{{ xibo_base_path | default('/opt/xibo-docker') }}"
    docker-compose restart
    
    log_success "Container neu gestartet"
}

# Hauptfunktion
main() {
    show_header
    check_root
    check_docker
    check_xibo_containers
    find_backups
    show_backups
    select_backup
    confirm_restore
    create_rollback
    perform_restore
    restart_containers
    
    echo ""
    echo "════════════════════════════════════════════════════════════════════════════"
    log_success "Restore erfolgreich abgeschlossen!"
    echo "════════════════════════════════════════════════════════════════════════════"
    echo ""
    log_info "Die Xibo-Installation wurde wiederhergestellt."
    log_info "Rollback-Sicherung: ${ROLLBACK_DIR}/pre_restore_*.zip"
    echo ""
}

# Script starten
main "$@"
