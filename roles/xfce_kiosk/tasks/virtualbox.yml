# ---------------------------------------------------------
# VirtualBox Guest Additions (nur wenn VM + aktiviert)
# ---------------------------------------------------------

- name: PrÃ¼fe ob System in VirtualBox lÃ¤uft
  ansible.builtin.debug:
    msg: "ðŸ–¥ï¸ VirtualBox erkannt"
  when: ansible_virtualization_type == "virtualbox"

- name: PrÃ¼fe ob vboxvideo geladen ist (X-tauglich)
  ansible.builtin.shell: lsmod | grep -q '^vboxvideo'
  register: vboxvideo_check
  failed_when: false
  changed_when: false
  when: ansible_virtualization_type == "virtualbox"

- name: Debug VBox X-Treiber Status
  ansible.builtin.debug:
    msg: "VirtualBox X-Grafiktreiber vorhanden: {{ vboxvideo_check.rc == 0 }}"
  when: ansible_virtualization_type == "virtualbox"

- block:

    - name: Installiere AbhÃ¤ngigkeiten fÃ¼r Guest Additions
      ansible.builtin.apt:
        name:
          - build-essential
          - dkms
          - linux-headers-{{ ansible_kernel }}
        state: present
        update_cache: yes
      become: yes

    - name: Entferne evtl. geladene alte VBox-Module
      ansible.builtin.shell: |
        rmmod vboxvideo vboxguest vboxsf 2>/dev/null || true
      become: yes
      changed_when: false

    - name: Download VirtualBox Guest Additions ISO
      ansible.builtin.get_url:
        url: "https://download.virtualbox.org/virtualbox/{{ virtualbox_version }}/VBoxGuestAdditions_{{ virtualbox_version }}.iso"
        dest: /tmp/VBoxGuestAdditions.iso
        mode: '0644'
      become: yes

    - name: Erstelle Mountpunkt
      ansible.builtin.file:
        path: /mnt/vbox
        state: directory
        mode: '0755'
      become: yes

    - name: Mount Guest Additions ISO
      ansible.builtin.mount:
        path: /mnt/vbox
        src: /tmp/VBoxGuestAdditions.iso
        fstype: iso9660
        opts: loop,ro
        state: mounted
      become: yes

    - name: Installiere VirtualBox Guest Additions (force rebuild)
      ansible.builtin.command: /mnt/vbox/VBoxLinuxAdditions.run --force
      become: yes
      register: vbox_install
      failed_when: "'error' in vbox_install.stdout.lower()"

    - name: Unmount ISO
      ansible.builtin.mount:
        path: /mnt/vbox
        state: unmounted
      become: yes

    - name: Cleanup ISO & Mountpunkt
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      become: yes
      loop:
        - /mnt/vbox
        - /tmp/VBoxGuestAdditions.iso

    - name: Reboot nach Guest Additions Installation
      ansible.builtin.reboot:
        reboot_timeout: 300
        msg: "Reboot nach VirtualBox Guest Additions"
      become: yes

  when:
    - virtualbox_guest_additions_enabled | default(false)
    - ansible_virtualization_type == "virtualbox"
    - vboxvideo_check.rc != 0

# ---------------------------------------------------------
# Post-Check (hartes Erfolgskriterium)
# ---------------------------------------------------------

- name: Verifiziere geladene VBox Kernel-Module
  ansible.builtin.shell: lsmod | grep '^vbox'
  register: vbox_modules
  changed_when: false
  when: ansible_virtualization_type == "virtualbox"

- name: Debug VBox Module
  ansible.builtin.debug:
    var: vbox_modules.stdout
  when: ansible_virtualization_type == "virtualbox"
