# ---------------------------------------------------------
# Idempotente VirtualBox Guest Additions + Module + Reboot
# ---------------------------------------------------------

- name: Pr√ºfe, ob System in VirtualBox l√§uft
  ansible.builtin.debug:
    msg: "üñ•Ô∏è VirtualBox erkannt"
  when: ansible_virtualization_type == "virtualbox"

- name: Pr√ºfe, ob vboxvideo geladen ist (X-tauglich)
  ansible.builtin.shell: lsmod | grep -q '^vboxvideo'
  register: vboxvideo_check
  failed_when: false
  changed_when: false
  when: ansible_virtualization_type == "virtualbox"

- name: Debug VBox X-Treiber Status
  ansible.builtin.debug:
    msg: "VirtualBox X-Grafiktreiber vorhanden: {{ vboxvideo_check.rc == 0 }}"
  when: ansible_virtualization_type == "virtualbox"

- block:

    - name: Installiere Abh√§ngigkeiten f√ºr Guest Additions
      ansible.builtin.apt:
        name:
          - build-essential
          - dkms
          - linux-headers-{{ ansible_kernel }}
        state: present
        update_cache: yes
      become: yes

    - name: Entferne evtl. alte VBox-Module vor Installation
      ansible.builtin.shell: |
        rmmod vboxvideo vboxguest vboxsf 2>/dev/null || true
      become: yes
      changed_when: false

    - name: Download VirtualBox Guest Additions ISO nur falls nicht vorhanden
      ansible.builtin.get_url:
        url: "https://download.virtualbox.org/virtualbox/{{ virtualbox_version }}/VBoxGuestAdditions_{{ virtualbox_version }}.iso"
        dest: /tmp/VBoxGuestAdditions.iso
        mode: '0644'
      become: yes

    - name: Erstelle Mountpunkt
      ansible.builtin.file:
        path: /mnt/vbox
        state: directory
        mode: '0755'
      become: yes

    - name: Mount Guest Additions ISO
      ansible.builtin.mount:
        path: /mnt/vbox
        src: /tmp/VBoxGuestAdditions.iso
        fstype: iso9660
        opts: loop,ro
        state: mounted
      become: yes

    - name: Installiere VirtualBox Guest Additions (force rebuild)
      ansible.builtin.command: /mnt/vbox/VBoxLinuxAdditions.run --force
      become: yes
      register: vbox_install
      failed_when: "'error' in vbox_install.stdout.lower()"

    - name: Unmount ISO
      ansible.builtin.mount:
        path: /mnt/vbox
        state: unmounted
      become: yes

    - name: Cleanup ISO & Mountpunkt
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      become: yes
      loop:
        - /mnt/vbox
        - /tmp/VBoxGuestAdditions.iso

    - name: Lade VBox Kernel-Module falls noch nicht geladen
      ansible.builtin.shell: |
        for mod in vboxguest vboxvideo vboxsf; do
          lsmod | grep -q "^$mod" || modprobe $mod
        done
      become: yes
      changed_when: false

    - name: Module automatisch beim Boot laden (idempotent)
      ansible.builtin.copy:
        dest: /etc/modules-load.d/vbox.conf
        content: |
          vboxguest
          vboxvideo
          vboxsf
        owner: root
        group: root
        mode: '0644'
      become: yes
      force: no  # nicht √ºberschreiben, wenn schon korrekt vorhanden

    - name: Reboot System (localhost)
      ansible.builtin.shell: shutdown -r now "Reboot durch Ansible"
      become: yes
      async: 1
      poll: 0
      ignore_errors: true

    - name: Pr√ºfe, ob die Module jetzt geladen sind
      ansible.builtin.shell: lsmod | grep '^vbox'
      register: vbox_modules
      changed_when: false
      become: yes

    - name: Debug VBox Module
      ansible.builtin.debug:
        var: vbox_modules.stdout

    - name: Reboot nur, falls Module noch nicht geladen waren
      ansible.builtin.reboot:
        reboot_timeout: 300
        msg: "Reboot nach Installation von VirtualBox Guest Additions"
      become: yes
      when: vboxvideo_check.rc != 0

  when:
    - virtualbox_guest_additions_enabled | default(false)
    - ansible_virtualization_type == "virtualbox"
