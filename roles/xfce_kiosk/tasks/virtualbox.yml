# ---------------------------------------------------------
# VirtualBox Guest Additions ‚Äì idempotent + boot-sicher
# ---------------------------------------------------------

- name: Pr√ºfe, ob wir in VirtualBox laufen
  ansible.builtin.debug:
    msg: "üñ•Ô∏è VirtualBox erkannt"
  when: ansible_virtualization_type == "virtualbox"

- name: Pr√ºfe, ob vboxvideo geladen ist (X-tauglich)
  ansible.builtin.shell: lsmod | grep -q '^vboxvideo'
  register: vboxvideo_check
  failed_when: false
  changed_when: false
  when: ansible_virtualization_type == "virtualbox"

- name: Debug VBox X-Treiber Status
  ansible.builtin.debug:
    msg: "VirtualBox X-Grafiktreiber vorhanden: {{ vboxvideo_check.rc == 0 }}"
  when: ansible_virtualization_type == "virtualbox"

- block:

    # 1Ô∏è‚É£ Dependencies installieren
    - name: Installiere Abh√§ngigkeiten f√ºr Guest Additions
      ansible.builtin.apt:
        name:
          - build-essential
          - dkms
          - linux-headers-{{ ansible_kernel }}
        state: present
        update_cache: yes
      become: yes

    # 2Ô∏è‚É£ Tempor√§re Installation der GA
    - name: Download VirtualBox Guest Additions ISO
      ansible.builtin.get_url:
        url: "https://download.virtualbox.org/virtualbox/{{ virtualbox_version }}/VBoxGuestAdditions_{{ virtualbox_version }}.iso"
        dest: /tmp/VBoxGuestAdditions.iso
        mode: '0644'
      become: yes

    - name: Erstelle tempor√§ren Mountpunkt
      ansible.builtin.file:
        path: /tmp/vbox-mount
        state: directory
        mode: '0755'
      become: yes

    - name: Tempor√§res Mounten der ISO
      ansible.builtin.mount:
        path: /tmp/vbox-mount
        src: /tmp/VBoxGuestAdditions.iso
        fstype: iso9660
        opts: loop,ro
        state: mounted
      become: yes

    - name: Installiere VirtualBox Guest Additions (force rebuild)
      ansible.builtin.command: /tmp/vbox-mount/VBoxLinuxAdditions.run --force
      become: yes
      register: vbox_install
      failed_when: "'error' in vbox_install.stdout.lower()"

    - name: Unmount tempor√§re ISO
      ansible.builtin.mount:
        path: /tmp/vbox-mount
        state: unmounted
      become: yes

    - name: Cleanup tempor√§re Dateien
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/VBoxGuestAdditions.iso
        - /tmp/vbox-mount
      become: yes

    # 3Ô∏è‚É£ Module laden
    - name: Lade VBox Kernel-Module falls noch nicht geladen
      ansible.builtin.shell: |
        for mod in vboxguest vboxvideo vboxsf; do
          lsmod | grep -q "^$mod" || modprobe $mod
        done
      become: yes
      changed_when: false

    - name: Module automatisch beim Boot laden (idempotent)
      ansible.builtin.copy:
        dest: /etc/modules-load.d/vbox.conf
        content: |
          vboxguest
          vboxvideo
          vboxsf
        owner: root
        group: root
        mode: '0644'
        force: no
      become: yes

    - name: Pr√ºfe, ob die Module jetzt geladen sind
      ansible.builtin.shell: lsmod | grep '^vbox'
      register: vbox_modules
      changed_when: false
      become: yes

    - name: Debug VBox Module
      ansible.builtin.debug:
        var: vbox_modules.stdout

    # 4Ô∏è‚É£ Reboot (nur, wenn Module vorher nicht geladen waren)
    - name: Reboot System (localhost) falls n√∂tig
      ansible.builtin.reboot:
        reboot_timeout: 300
        msg: "Reboot nach Installation von VirtualBox Guest Additions"
      become: yes
      when: vboxvideo_check.rc != 0

  when:
    - virtualbox_guest_additions_enabled | default(false)
    - ansible_virtualization_type == "virtualbox"
