################################################################################
# Xibo Digital Signage - Standalone Installation
################################################################################

- name: Lokale Basiskonfiguration
  hosts: local
  gather_facts: yes
  become: yes

  vars:
    local_user: "{{ lookup('env','USER') }}"
    kiosk_reboot_marker: /var/run/kiosk_reboot_done

  vars_files:
    - group_vars/secrets.yml

  pre_tasks:
    ###########################################################################
    # Interaktive Abfrage mit Timeout (Default = manuell)
    ###########################################################################
    - name: Frage nach automatischem Fortsetzen nach Reboots (30s Timeout)
      ansible.builtin.pause:
        prompt: |
          ‚öôÔ∏è  Auto-Continue nach Reboots aktivieren?

          Das Playbook kann sich nach jedem Reboot automatisch fortsetzen,
          bis die Installation vollst√§ndig abgeschlossen ist.

          üëâ Tippe **yes** innerhalb von 30 Sekunden zum Aktivieren.
          üëâ ENTER, Timeout oder andere Eingabe = manuell
        seconds: 30
      register: auto_continue_prompt

    - name: Setze auto_continue_confirm Flag
      ansible.builtin.set_fact:
        auto_continue_confirm: "{{ auto_continue_prompt.user_input | default('') }}"

    ###########################################################################
    # Systemd Service erstellen (immer)
    ###########################################################################
    - name: Erstelle Ansible auto-continue Service
      ansible.builtin.copy:
        dest: /etc/systemd/system/ansible-continue.service
        mode: '0644'
        content: |
          [Unit]
          Description=Continue Ansible Playbook after reboot
          After=network-online.target
          Wants=network-online.target

          [Service]
          Type=oneshot
          User=root
          WorkingDirectory={{ playbook_dir }}
          ExecStart=/usr/bin/ansible-playbook -i hosts playbook.yml
          RemainAfterExit=yes

          [Install]
          WantedBy=multi-user.target

    ###########################################################################
    # Auto-Continue nur bei exakt "yes"
    ###########################################################################
    - name: Enable Ansible auto-continue Service
      ansible.builtin.systemd:
        name: ansible-continue
        enabled: yes
        daemon_reload: yes
      when: auto_continue_confirm == "yes"

    - name: Info wenn auto-continue NICHT aktiviert
      ansible.builtin.debug:
        msg: >
          ‚ÑπÔ∏è Auto-Continue deaktiviert.
          Nach jedem Reboot bitte manuell ausf√ºhren:
          sudo ansible-playbook -i hosts playbook.yml
      when: auto_continue_confirm != "yes"

  ###########################################################################
  # Rollen
  ###########################################################################
  roles:
    - base
    - xibo-docker
    - xfce_kiosk
    - xibo-player

  ###########################################################################
  # Abschluss & Cleanup
  ###########################################################################
  post_tasks:
    - name: Pr√ºfe ob alle Setups abgeschlossen sind
      ansible.builtin.stat:
        path: "{{ item }}"
      register: setup_markers
      loop:
        - /etc/xfce-kiosk-setup-completed
        - /etc/xibo-player-setup-completed

    - name: Deaktiviere auto-continue Service (Setup komplett)
      ansible.builtin.systemd:
        name: ansible-continue
        enabled: no
        state: stopped
      when: setup_markers.results | selectattr('stat.exists') | list | length == 2

    - name: Setup abgeschlossen
      ansible.builtin.debug:
        msg: "üéâ Komplettes Xibo Display Setup erfolgreich abgeschlossen!"
      when: setup_markers.results | selectattr('stat.exists') | list | length == 2
