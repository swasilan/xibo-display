################################################################################
# Xibo Digital Signage - Standalone Installation
################################################################################
# 
# Dieses Playbook richtet eine vollst√§ndige Xibo Digital Signage L√∂sung auf
# einer einzelnen Maschine ein:
#
#   - Xibo CMS (Docker-basiert)
#   - Xibo Player (Snap-basiert)
#   - XFCE Kiosk-Modus f√ºr automatischen Player-Start
#   - Automatische Konfiguration und Verbindung zwischen CMS und Player
#
# Die Installation erfolgt vollautomatisch inklusive Reboots und setzt nach
# jedem Neustart automatisch fort bis das Setup vollst√§ndig abgeschlossen ist.
#
# Voraussetzungen:
#   - Ubuntu Server 24.04 LTS
#   - Mindestens 4GB RAM, 20GB Festplatte
#   - Internetzugang
#
# Verwendung:
#   sudo ansible-playbook -i hosts playbook.yml
#
################################################################################
- name: Lokale Basiskonfiguration
  hosts: local
  gather_facts: yes
  become: yes
  vars:
    local_user: "{{ lookup('env','USER') }}"
    kiosk_reboot_marker: /var/run/kiosk_reboot_done
  vars_files:
    - group_vars/secrets.yml  # enth√§lt Xibo DB/Player Passw√∂rter etc.
  pre_tasks:
    ###########################################################################
    # Frage User ob automatisches Fortsetzen gew√ºnscht ist (30s Timeout)
    ###########################################################################
    - name: Frage nach automatischem Fortsetzen nach Reboots
      pause:
        prompt: |
          
          ‚öôÔ∏è  Auto-Continue nach Reboots aktivieren?
          
          Das Playbook kann sich nach jedem Reboot automatisch fortsetzen,
          bis die Installation vollst√§ndig abgeschlossen ist.
          
          Tippe 'yes' zum Aktivieren oder dr√ºcke Enter zum √úberspringen
          (Auto-Timeout in 30 Sekunden):
        seconds: 30
        echo: yes
      register: auto_continue_confirm
      when: ansible_connection == 'local'

    ###########################################################################
    # Systemd Service erstellen, um Playbook nach Reboot automatisch fortzusetzen
    ###########################################################################
    - name: Erstelle Ansible auto-continue Service (als Root)
      ansible.builtin.copy:
        dest: /etc/systemd/system/ansible-continue.service
        content: |
          [Unit]
          Description=Continue Ansible Playbook after reboot
          After=network-online.target
          Wants=network-online.target
          [Service]
          Type=oneshot
          User=root
          WorkingDirectory={{ playbook_dir }}
          ExecStart=/usr/bin/ansible-playbook -i hosts playbook.yml
          RemainAfterExit=yes
          [Install]
          WantedBy=multi-user.target
        mode: '0644'

    - name: Enable Ansible auto-continue Service
      ansible.builtin.systemd:
        name: ansible-continue
        enabled: yes
        daemon_reload: yes
      when: auto_continue_confirm.user_input is defined and auto_continue_confirm.user_input == "yes"

    - name: Info wenn auto-continue nicht aktiviert
      ansible.builtin.debug:
        msg: "‚ÑπÔ∏è Auto-Continue Service erstellt aber nicht aktiviert. Nach jedem Reboot manuell 'sudo ansible-playbook -i hosts playbook.yml' ausf√ºhren."
      when: auto_continue_confirm.user_input is not defined or auto_continue_confirm.user_input != "yes"

  roles:
    - base
    - xibo-docker
    - xfce_kiosk
    - xibo-player
  ###########################################################################
  # OPTIONAL: Reboot-Mechanismus
  ###########################################################################
  tasks:
    - name: Pr√ºfe ob Reboot bereits durchgef√ºhrt wurde
      ansible.builtin.stat:
        path: "{{ kiosk_reboot_marker }}"
      register: reboot_done
    - name: Reboot Kiosk (einmalig)
      ansible.builtin.reboot:
        reboot_timeout: 600
      when: not reboot_done.stat.exists
      become: yes
    - name: Marker-Datei nach Reboot anlegen
      ansible.builtin.file:
        path: "{{ kiosk_reboot_marker }}"
        state: touch
      when: not reboot_done.stat.exists
      become: yes
  post_tasks:
    ###########################################################################
    # Marker-Dateien f√ºr abgeschlossene Setups pr√ºfen
    ###########################################################################
    - name: Pr√ºfe ob alle Setups abgeschlossen sind
      ansible.builtin.stat:
        path: "{{ item }}"
      register: setup_markers
      loop:
        - /etc/xfce-kiosk-setup-completed
        - /etc/xibo-player-setup-completed
    - name: Deaktiviere auto-continue Service (Setup komplett)
      ansible.builtin.systemd:
        name: ansible-continue
        enabled: no
        state: stopped
      when: setup_markers.results | selectattr('stat.exists') | list | length == 2
    - name: Setup abgeschlossen
      ansible.builtin.debug:
        msg: "üéâ Komplettes Xibo Display Setup erfolgreich abgeschlossen!"
      when: setup_markers.results | selectattr('stat.exists') | list | length == 2
